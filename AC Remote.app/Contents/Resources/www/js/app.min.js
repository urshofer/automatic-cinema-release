/*! automatic-cinema-controller 2015-04-02 */
angular.module("starter",["ionic","starter.services","starter.controllers","angular-md5"]).config(function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var param=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else if(value instanceof Object)for(subName in value)subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&"[object File]"!==String(data)?param(data):data}],$httpProvider.defaults.transformResponse=[]}).run(function($ionicPlatform){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),console.log("Platform initialized...")})}).config(function($stateProvider,$urlRouterProvider){$stateProvider.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.index",{url:"/index",views:{menuContent:{templateUrl:"templates/index.html",controller:"LoginCtrl"}}}).state("app.target",{url:"/target",views:{menuContent:{templateUrl:"templates/target.html",controller:"TargetCtrl"}}}).state("app.style",{url:"/style",views:{menuContent:{templateUrl:"templates/style.html",controller:"StyleCtrl"}}}).state("app.timeline",{url:"/timeline",views:{menuContent:{templateUrl:"templates/timeline.html",controller:"TimelineCtrl"}}}).state("app.graph",{url:"/graph",views:{menuContent:{templateUrl:"templates/graph.html",controller:"GraphCtrl"}}}).state("app.content",{url:"/content",views:{menuContent:{templateUrl:"templates/content.html",controller:"ContentCtrl"}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsCtrl"}}}),$urlRouterProvider.otherwise("/app/index")}),angular.module("starter.services",["ngCookies","ngResource","ng"]).factory("PaperService",function(){console.log("PaperService initialized...");var canvas,max=[0,0],_storeMax=function(x,y){x>max[0]&&(max[0]=x),y>max[1]&&(max[1]=y)},_path=function(points,linewidth,col,dash){void 0==dash&&(dash=!1),void 0==col&&(col=[0,0,0]),void 0==linewidth&&(linewidth=1);var p=new paper.Path;return p.strokeColor=new paper.Color(col),p.strokeWidth=linewidth,dash&&(p.dashArray=[dash[0],dash[1]?dash[1]:dash[0]]),angular.forEach(points,function(point){p.add(new paper.Point(Math.floor(point[0]),Math.floor(point[1]))),_storeMax(point[0],point[1])}),p.translate(new paper.Point(.5,.5)),p};return{init:function(_canvas){canvas=_canvas,paper.setup(canvas),max=[0,0]},clear:function(){paper.project.activeLayer.hasChildren()&&(paper.project.activeLayer.removeChildren(),max=[0,0])},getMax:function(){return{x:max[0],y:max[1]}},update:function(){paper.view.draw()},draw:function(){canvas.width=parseInt(max[0]),canvas.height=parseInt(max[1]),canvas.style.width=canvas.width+"px",canvas.style.height=canvas.height+"px",paper.view.draw()},path:function(points,linewidth,col,dash){_path(points,linewidth,col,dash)},text:function(x,y,str,size,col,font,rotate){void 0==size&&(size=9),void 0==col&&(col=[0,0,0]),void 0==font&&(font="Helvetica"),void 0==rotate&&(rotate=!1);var t=new paper.PointText(new paper.Point(Math.floor(x),Math.floor(y)));return t.content=str,t.characterStyle={font:font,fontSize:size,fillColor:new paper.Color(col)},rotate&&t.rotate(rotate,new paper.Point(Math.floor(x),Math.floor(y))),_storeMax(x+t.bounds.width,y+t.bounds.height),t.translate(new paper.Point(.5,.5)),t},rect:function(x,y,w,h,bcol,fcol,linewidth,hsl){void 0==hsl&&(hsl=!1),void 0==linewidth&&(linewidth=1),void 0==bcol&&(bcol=[0,0,0]),void 0==fcol&&(col=[0,0,0]);var p=new paper.Path.Rectangle(new paper.Rectangle(Math.floor(x),Math.floor(y),Math.floor(w),Math.floor(h)));bcol&&(p.strokeColor=hsl?new paper.HslColor(bcol[0],bcol[1],bcol[2]):new paper.Color(bcol)),fcol&&(p.fillColor=hsl?new paper.HslColor(bcol[0],bcol[1],bcol[2]):new paper.Color(bcol)),p.strokeWidth=linewidth,p.translate(new paper.Point(.5,.5)),_storeMax(x+p.bounds.width,y+p.bounds.height)},circle:function(x,y,r,bcol,fcol,linewidth,hsl){void 0==hsl&&(hsl=!1),void 0==linewidth&&(linewidth=1),void 0==bcol&&(bcol=[0,0,0]),void 0==fcol&&(col=[0,0,0]);var p=new paper.Path.Circle(new paper.Point(Math.floor(x),Math.floor(y)),Math.floor(r));bcol&&(p.strokeColor=hsl?new paper.HslColor(bcol[0],bcol[1],bcol[2]):new paper.Color(bcol)),fcol&&(p.fillColor=hsl?new paper.HslColor(bcol[0],bcol[1],bcol[2]):new paper.Color(bcol)),p.strokeWidth=linewidth,p.translate(new paper.Point(.5,.5)),_storeMax(x+r,y+r)},polyfill:function(points,bcol,fcol,linewidth){void 0==bcol&&(bcol=[0,0,0]),void 0==fcol&&(col=[0,0,0]);var p=_path(points,linewidth,bcol);fcol&&(p.closePath(),p.fillColor=new paper.Color(fcol))}}}).factory("NetService",function($resource,$q,$http){console.log("Network initialized...");var channels={};return{check:function(token){var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/CheckSession/"+token).then(function(response){deferred.resolve("true"==response.data?!0:!1)}),deferred.promise},login:function(user,pass){console.log("Login: "+user);var deferred=$q.defer();return $http.post(window.localStorage.endpoint+"/Login",{username:user,password:pass}).then(function(response){data=angular.fromJson(response.data),console.log(data),deferred.resolve(data.Error?!1:data)}),deferred.promise},load:function(type,token){var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/Load/"+token+"/"+type).then(function(response){data=angular.fromJson(response.data),deferred.resolve(data.Error?data:data)}),deferred.promise},loadconfig:function(token){var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/LoadConfig/"+token).then(function(response){var configuration=angular.fromJson(response.data);deferred.resolve(configuration)}),deferred.promise},loadoptions:function(token){var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/LoadOptions/"+token).then(function(response){var data=angular.fromJson(response.data);console.log(data);var ret=data;(null==ret.style||null==ret.target||null==ret.content)&&(ret.Error={},ret.Error.Code=100,ret.Error.Message="Style, Target or Content missing."),null==ret.shows&&(ret.Error={},ret.Error.Code=100,ret.Error.Message="Show missing."),deferred.resolve(ret)}),deferred.promise},loadchannels:function(token,active_only){filter=void 0==active_only||0==active_only?"/all":"";var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/Channels/"+token+filter).then(function(response){channels=angular.fromJson(response.data),deferred.resolve(channels)}),deferred.promise},channelstate:function(token){var deferred=$q.defer(),state={},ch_count=channels.length;return angular.forEach(channels,function(value){$http.get(window.localStorage.endpoint+"/State/"+token+"/"+value.name).then(function(response){state[value.name]=angular.fromJson(response.data),ch_count--,0==ch_count&&deferred.resolve(state)})}),deferred.promise},"delete":function(contribid,state,token){var deferred=$q.defer();return $http.delete(window.localStorage.endpoint+"/Delete/"+token+"/"+state+"/"+contribid).then(function(response){deferred.resolve(response.data)}),deferred.promise},toggle:function(contribid,state,token){var deferred=$q.defer();return $http.get(window.localStorage.endpoint+"/Toggle/"+token+"/"+contribid+"/"+state).then(function(response){deferred.resolve(response.data)}),deferred.promise},rename:function(contribid,newname,token,state){var deferred=$q.defer();return $http.post(window.localStorage.endpoint+"/Rename/"+token+"/"+state+"/"+contribid,{newname:newname}).then(function(response){deferred.resolve(response.data)}),deferred.promise},timeline:function(token,action){var deferred=$q.defer();if("load"==action){var timeline={},ch_count=channels.length;angular.forEach(channels,function(value){$http.get(window.localStorage.endpoint+"/Timeline/"+token+"/"+value.name).then(function(response){if(timeline[value.name]=angular.fromJson(response.data),ch_count--,0==ch_count){var ch_n=[],tl={};angular.forEach(timeline,function(value,key){ch_n.push(key)}),ch_n.sort(),angular.forEach(ch_n,function(value){tl[value]=timeline[value]}),deferred.resolve(tl)}})})}else if("trigger"==action){var ch_count=channels.length;console.log(ch_count),angular.forEach(channels,function(value){$http.get(window.localStorage.endpoint+"/Next/"+token+"/"+value.name).then(function(){ch_count--,0==ch_count&&deferred.resolve(!0)})})}else"reset"==action&&$http.get(window.localStorage.endpoint+"/Reset/"+token).then(function(){deferred.resolve(!0)});return deferred.promise},store:function(data,type,token){var deferred=$q.defer();return $http.post(window.localStorage.endpoint+"/Store/"+token+"/"+type,data).then(function(response){deferred.resolve(angular.fromJson(response.data))}),deferred.promise}}}),angular.module("starter.controllers",["ionic"]).controller("AppCtrl",function($rootScope,$scope,$ionicPopup,NetService,md5,$q,$state){void 0==window.localStorage.isunlocked&&(window.localStorage.isunlocked=!1),$scope.isunlocked=window.localStorage.isunlocked,$rootScope.$on("$stateChangeStart",function(){$scope.isunlocked=window.localStorage.isunlocked,$rootScope.interval&&clearInterval($rootScope.interval)}),$scope.f=function(n,w){var n_=Math.abs(n),zeros=Math.max(0,w-Math.floor(n_).toString().length),zeroString=Math.pow(10,zeros).toString().substr(1);return 0>n&&(zeroString="-"+zeroString),zeroString+n},$scope.storeTime=function(){console.log("Stored Time: "+$scope.time),$scope.send({time:$scope.time},"time")},$scope.changePreroll=function(preroll){$scope.preroll=preroll,$scope.prerolltimeout&&clearTimeout($scope.prerolltimeout),$scope.prerolltimeout=setTimeout($scope.storePreroll,500)},$scope.storePreroll=function(){console.log("Stored Preroll: "+$scope.preroll),$scope.send({preroll:$scope.preroll},"preroll")},$scope.changeTime=function(time){$scope.time=time,$scope.formatted=$scope.f(Math.floor(time/60),2)+":"+$scope.f(time%60,2),$scope.timeout&&clearTimeout($scope.timeout),$scope.timeout=setTimeout($scope.storeTime,500)},$scope.doLogin=function(){return $scope.log_deferred=$q.defer(),void 0!=$scope.auth_token?(console.log("Checking: "+$scope.auth_token),NetService.check($scope.auth_token).then(function(checked){checked?($scope.log_deferred.resolve(!0),$scope.loadconfig()):$scope.loginPop(!0)})):void 0==window.localStorage.user||void 0==window.localStorage.pass?$scope.loginPop(!0):NetService.login(window.localStorage.user,window.localStorage.pass).then(function(api_endpoint){api_endpoint?($scope.auth_token=api_endpoint,$scope.log_deferred.resolve(!0)):$scope.loginPop(!0)}),$scope.log_deferred.promise},$scope.loginPop=function(force){if(void 0==window.localStorage.endpoint||void 0==window.localStorage.user||void 0==window.localStorage.pass||force){$scope.data={},$scope.data.api=window.localStorage.endpoint,$scope.data.user=window.localStorage.user;var myPopup=$ionicPopup.show({template:'<label class="item item-input"><input type="text" placeholder="Api Endpoint" ng-model="data.api"></label><label class="item item-input"><input type="text" placeholder="Username" ng-model="data.user"></label><label class="item item-input"><input type="password" placeholder="Password" ng-model="data.password"></label>',title:"Setup",subTitle:"Please log in and set the api endpoint.",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Save</b>",type:"button-positive",onTap:function(e){return $scope.data.password&&$scope.data.user&&$scope.data.api?$scope.data:void e.preventDefault()}}]});myPopup.then(function(data){void 0!=data?(window.localStorage.endpoint=data.api,window.localStorage.user=data.user,window.localStorage.pass=md5.createHash(data.password),$scope.auth_token=void 0,$scope.doLogin()):console.log("Cancel")})}},$scope.unlock=function(){if($scope.isunlocked)$scope.isunlocked=!1,window.localStorage.isunlocked=$scope.isunlocked,$state.go("app.target");else{$scope.data={};var myPopup=$ionicPopup.show({template:'<label class="item item-input"><input type="text" placeholder="Unlock Code" ng-model="data.lockcode"></label>',title:"Unlock",subTitle:"Unlock the remote to show all settings.",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Unlock</b>",type:"button-positive",onTap:function(e){return $scope.data.lockcode?$scope.data:void e.preventDefault()}}]});myPopup.then(function(data){void 0!=data?(void 0==window.localStorage.lock&&(window.localStorage.lock=data.lockcode),window.localStorage.isunlocked=data.lockcode==window.localStorage.lock?!0:!1,$scope.isunlocked=window.localStorage.isunlocked):console.log("Cancel")})}},$scope.send=function(data,type){NetService.store(data,type,$scope.auth_token)},$scope.loadconfig=function(){console.log("Load Configuration"),NetService.loadconfig($scope.auth_token).then(function(data){$scope.configuration=data,console.log($scope.configuration),$scope.time=parseInt($scope.configuration.time),$scope.preroll=$scope.configuration.preroll,$scope.formatted=$scope.f(Math.floor($scope.time/60),2)+":"+$scope.f($scope.time%60,2)})}}).controller("LoginCtrl",function($scope){$scope.doLogin()}).controller("SettingsCtrl",function($scope,$stateParams,NetService,$ionicPopup,$ionicModal,$ionicLoading){$scope.lock=function($scope){$scope.lockcode=window.localStorage.lock,$scope.savecode=function(){window.localStorage.lock=$scope.lockcode}},$scope.change=function(){NetService.store($scope.configuration,"config",$scope.auth_token).then(function(data){data.Error?$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}):$scope.reload()})},$scope.toggle=function(channel){channel.status="Open"==channel.status?"Close":"Open",NetService.toggle(channel.name,channel.status,$scope.auth_token)},$scope.delete=function(channel,type){var confirmPopup=$ionicPopup.confirm({title:"Delete "+type+" "+channel,template:"Are you sure you want to delete this "+type+"?"});confirmPopup.then(function(res){res&&NetService.delete(channel,type,$scope.auth_token).then(function(){$scope.reload()})})},$scope.reload=function(){$ionicLoading.show({template:"Loading...",delay:500}),null==$scope.configuration&&$scope.loadconfig(),NetService.loadoptions($scope.auth_token).then(function(data){data.Error&&$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}),$scope.options=data,NetService.loadchannels($scope.auth_token).then(function(data){data.Error&&$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}),$scope.channels=data,$ionicLoading.hide()})})},$ionicModal.fromTemplateUrl("addshow.html",{scope:$scope,animation:"slide-in-up"}).then(function(data){$scope.show_modal=data}),$ionicModal.fromTemplateUrl("addchannel.html",{scope:$scope,animation:"slide-in-up"}).then(function(data){$scope.channel_modal=data}),$ionicModal.fromTemplateUrl("addstyle.html",{scope:$scope,animation:"slide-in-up"}).then(function(data){$scope.style_modal=data}),$ionicModal.fromTemplateUrl("addtarget.html",{scope:$scope,animation:"slide-in-up"}).then(function(data){$scope.target_modal=data}),$ionicModal.fromTemplateUrl("addcontent.html",{scope:$scope,animation:"slide-in-up"}).then(function(data){$scope.content_modal=data}),$scope.add=function(type){"channel"==type&&($scope.active_modal=$scope.channel_modal),"show"==type&&($scope.active_modal=$scope.show_modal),"style"==type&&($scope.active_modal=$scope.style_modal),"target"==type&&($scope.active_modal=$scope.target_modal),"content"==type&&($scope.active_modal=$scope.content_modal),$scope.active_modal.data={},$scope.active_modal.show()},$scope.close=function(){$scope.active_modal.hide()},$scope.save=function(type){NetService.store($scope.active_modal.data,"add"+type,$scope.auth_token).then(function(data){data.Error&&$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}),$scope.reload(),$scope.close()})},$scope.$on("$destroy",function(){void 0!=$scope.active_modal&&$scope.active_modal.remove()}),$scope.rename=function(channel,type){var c={name:channel};$scope.pop=c,$ionicPopup.show({template:'<label class="item item-input"><input type="input" placeholder="New Name" ng-model="pop.name"></label>',title:"Rename "+type+" "+channel,subTitle:"Type in the new name of the "+type+".",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Save</b>",type:"button-positive",onTap:function(e){return $scope.pop.name?$scope.pop.name:void e.preventDefault()}}]}).then(function(newname){void 0!=newname&&NetService.rename(channel,newname,$scope.auth_token,type).then(function(){$scope.reload()})})},$scope.doLogin().then(function(state){state===!0&&$scope.reload()})}).controller("TargetCtrl",function($scope,$stateParams,$q,$ionicPopup,NetService){$scope.doLogin().then(function(state){state===!0&&NetService.load("target",$scope.auth_token).then(function(data){return data.Error?void $ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}):void $("target").makeTarget({json:data,onRender:function(){},onSave:function(){$scope.send({data:this._datapool},"target")}})})})}).controller("StyleCtrl",function($scope,$stateParams,$q,$ionicPopup,NetService){$scope.drawChannels=function(cloud){$scope.cloud=cloud,$scope.channels=cloud.exportChannels(),console.log($scope.channels)},$scope.openChannel=function(id){$scope.cloud.switchChannel(id)},$scope.doLogin().then(function(state){state===!0&&NetService.load("style",$scope.auth_token).then(function(data){return data.Error?void $ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}):void $("stylematrix").makeCloud({data:data,onRender:function(){$scope.drawChannels(this)},onSave:function(){$scope.send({data:this._datapool},"style")}})})})}).controller("ContentCtrl",function($scope,$stateParams,$q,$ionicPopup,NetService){$scope.automaticrefresh=!1,$scope.ontologyReload=function(){NetService.load("content",$scope.auth_token).then(function(data){return data.Error?void $ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}):($scope.data=data,$scope.ontology.options.data=$scope.data,$scope.ontology.loadJSON($scope.ontology.options.data),void $scope.ontology.redraw())})},$scope.refreshData=function(){$scope.refreshinterval?(clearInterval($scope.refreshinterval),$scope.automaticrefresh=!1,$scope.refreshinterval=!1):($scope.refreshinterval=setInterval($scope.ontologyReload,3e3),$scope.automaticrefresh=!0)},$scope.drawDimensions=function(ontology){$scope.ontology=ontology,$scope.dimensions=ontology.exportDimensions(),console.log($scope.dimensions)},$scope.switchDimension=function(id){$scope.ontology.switchDimension(id)},$scope.deleteDimension=function(){var confirmPopup=$ionicPopup.confirm({title:"Delete Active Dimension",template:"Are you sure you want to delete this dimension?"});confirmPopup.then(function(res){res&&$scope.ontology&&$scope.ontology.deleteDimension(!0)})},$scope.renameDimension=function(){$scope.pop={},$ionicPopup.show({template:'<label class="item item-input"><input type="input" placeholder="New Name" ng-model="pop.name"></label>',title:"Rename Dimension",subTitle:"Type in the new name of the active dimension.",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Save</b>",type:"button-positive",onTap:function(e){return $scope.pop.name?$scope.pop.name:void e.preventDefault()}}]}).then(function(newname){void 0!=$scope.ontology&&void 0!=newname&&$scope.ontology.renameDimension(newname)})},$scope.addDimension=function(){$scope.pop={};var myPopup=$ionicPopup.show({template:'<label class="item item-input"><input type="input" placeholder="New Name" ng-model="pop.new"></label>',title:"Add Dimension",subTitle:"Type in the name of the new Dimension.",scope:$scope,buttons:[{text:"Cancel"},{text:"<b>Save</b>",type:"button-positive",onTap:function(e){return $scope.pop.new?$scope.pop.new:void e.preventDefault()}}]});myPopup.then(function(newname){void 0!=$scope.ontology&&void 0!=newname&&$scope.ontology.addDimension(newname)})},$scope.swapArrow=function(){$ionicPopup.show({title:"Arrow Type",subTitle:"Choose the arrow type.",buttons:[{text:"",type:"button button-icon button-balanced icon button-clear ion-ios7-minus-empty",onTap:function(){return 1}},{text:"",type:"button button-icon button-assertive icon button-clear ion-ios7-minus-empty",onTap:function(){return 2}},{text:"",type:"button button-icon button-balanced icon button-clear ion-ios7-arrow-thin-right",onTap:function(){return 3}},{text:"",type:"button button-icon button-assertive icon button-clear ion-ios7-arrow-thin-right",onTap:function(){return 4}}]}).then(function(type){void 0!=$scope.ontology&&void 0!=type&&$scope.ontology.changeLineStyle(type)})},$scope.doLogin().then(function(state){state===!0&&NetService.load("content",$scope.auth_token).then(function(data){return data.Error?void $ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}):($scope.data=data,$("uploader_close").addEvent("click",function(){this.getParent("div.uploadlayer").setStyle("display","none"),this.setStyle("display","none"),$("dimtags").removeEvents("click"),$("dimtags").setStyle("display","none").set("html","")}),void $("ontology").makeOntology({data:$scope.data,onRender:function(){$scope.drawDimensions(this);var self=this;$("uploadform").action=window.localStorage.endpoint+"/StoreFile/"+$scope.auth_token;new Form.Upload("url",{dropMsg:"",fireAtOnce:!0,dropzone:"ontology",showlist:!1,showprogress:"progress",onDrop:function(e,files){var dim=self.currentDimension(),pos=self.convertCoordinate(e.event.clientX,e.event.clientY);$("add_dim").value=self.currentDimension(),$("add_x").value=pos.x,$("add_y").value=pos.y,$("tit").set("html","Dropping "+files[files.length-1].name+" in "+dim),$("uploader").setStyle("opacity",0).setStyle("display","block").fade("in"),$("progress").setStyle("opacity",0).setStyle("display","block").fade("in")},onComplete:function(json){$("uploader_close").setStyle("display","block"),$("progress").setStyle("display","none");var data_complete=angular.fromJson(json);if(data_complete.Error||!data_complete)return void $ionicPopup.alert({title:"Error "+data_complete.Error.Code,template:data_complete.Error.Message});$("tit").set("html","Choose additional attributes"),$("dimtags").setStyle("opacity",0).setStyle("display","block").fade("in"),size=$("dimtags").getSize(),pos=$("dimtags").getPosition(),$("dimtags").activeDim=!1,$("dimtags").object=data_complete.object,$("dimtags").preview=data_complete.preview,self.redraw(data_complete.metadata);for(var k in data_complete.keywords)for(var e in data_complete.keywords[k])if(e<=data_complete.keywords[k].length){console.log("add "+k+"/"+data_complete.keywords[k][e][0]+"/"+data_complete.keywords[k][e][1][0]+"x"+data_complete.keywords[k][e][1][1]);var _data=data_complete.keywords[k][e],e=Element("div",{"class":"adtags dim_"+k,id:"kw"+k+"_"+e,html:_data[0],styles:{"margin-left":size.x/100*_data[1][0],"margin-top":size.y/100*_data[1][1]}}).inject($("dimtags"));e.k=k,e.addEvents({click:function(){var on=function(){this.toggleClass("adtag_highlight")}.bind(this),timer=on.periodical(50),off=function(){clearTimeout(timer),this.addClass("adtag_highlight")}.bind(this);off.delay(500)},mouseover:function(){$$("div.adtags").setStyle("z-index",0),$$("div.adtags").removeClass("adtag_highlight"),$("dimtags").activeDim=this.k,$$("div.dim_"+this.k).each(function(e){e.addClass("adtag_highlight"),e.setStyle("z-index",1)})}})}$("dimtags").addEvent("click",function(e){if(e.stop(),this.activeDim){var send={dim:this.activeDim,object:this.object,preview:this.preview,x:100/size.x*(e.client.x-pos.x),y:100/size.y*(e.client.y-pos.y)};NetService.store(send,"annotate",$scope.auth_token).then(function(data){self.redraw(data)})}else{var on=function(){$$("div.adtags").toggleClass("adtag_highlight")},timer=on.periodical(50),off=function(){clearTimeout(timer),$$("div.adtags").removeClass("adtag_highlight")};off.delay(500)}})}})},previewPrefix:window.localStorage.endpoint+"/Preview/"+$scope.auth_token+"/",onSave:function(){$scope.send({data:this._datapool},"content")}}))})})}).controller("TimelineCtrl",function($rootScope,$scope,$stateParams,$q,NetService,PaperService,$ionicScrollDelegate){$scope.zoomfactor=.2,$scope.o={},$scope.o.chn_l=10,$scope.o.chn_t=17,$scope.o.chn_s=20,$scope.o.chn_v=20,$scope.o.leg_w=50,$scope.o.clp_v=25,$scope.o.scr_v=50,$scope.o.dim_v=25,$scope.o.leg_v=200,$scope.o.gut_v=2,$scope.o.gut_h=2,$scope.o.gut_rv=0,$scope.o.gut_rh=0,$scope.o.col_b=[1,1,1],$scope.o.col_s=[.6,.6,.6],$scope.o.col_d=[.3,.3,.3],$scope.o.col_p=[0,1,0],$scope.o.col_t=[1,0,0],$scope.o.col_h=[.2,.4,1],$scope.o.fnt_b=14,$scope.o.fnt_s=9,$scope.o.s_min=.002,$scope.o.s_max=.01,$scope.timeline={},$scope.titles=[],$scope.isLoading=!1,$scope.adjustTitles=function(){$ionicScrollDelegate.$getByHandle("timelinescroll").getScrollPosition().left;angular.forEach($scope.titles,function(){})},$scope.draw=function(){PaperService.clear(),$scope.o.fct_t=($scope.o.s_min+($scope.o.s_max-$scope.o.s_min))*$scope.zoomfactor;var top=0,lines=[],lines_dotted=[];$scope.titles=[],angular.forEach($scope.timeline,function(_data,name){var data=_data.data,live=_data.live||0;if(null!=data&&data.length>0){top+=$scope.o.chn_t,$scope.titles.push(PaperService.text($scope.o.chn_l,top+$scope.o.fnt_b/3,name,$scope.o.fnt_b,$scope.o.col_b)),top+=$scope.o.chn_s,$scope.e=!1;var lp=[],lh=[],lt=[],ld=[],_sc_p=[],_sc_h=[],_sc_t=[],_sc_d=[],x=0,v_lines=[];if(lines.push(top),lines.push(top+$scope.o.clp_v),lines.push(top+($scope.o.clp_v+$scope.o.scr_v)),angular.forEach(data,function(e){if(e.element_id){$scope.e=e,x=$scope.o.chn_l+$scope.o.leg_w+e.element_in*$scope.o.fct_t;var hsl=!1,color=$scope.o.col_s;e.element_parameters.Hue&&(color=[parseFloat(e.element_parameters.Hue),.01*e.element_parameters.Saturation,.01*e.element_parameters.Luminosity],hsl=!0),PaperService.rect(x+$scope.o.gut_rh,top+$scope.o.gut_rv,e.element_duration*$scope.o.fct_t-2*$scope.o.gut_rh,$scope.o.clp_v-2*$scope.o.gut_rv,color,color,1,hsl),-1==v_lines.indexOf(x)&&v_lines.push(x),v_lines.push(x+e.element_duration*$scope.o.fct_t),lp=[x,top+($scope.o.clp_v+$scope.o.scr_v)-($scope.o.scr_v-2*$scope.o.gut_v)*e.element_score_physical],lh=[x,top+($scope.o.clp_v+$scope.o.scr_v)-($scope.o.scr_v-2*$scope.o.gut_v)*e.element_score_demerit],lt=[x,top+($scope.o.clp_v+$scope.o.scr_v)-($scope.o.scr_v-2*$scope.o.gut_v)*e.element_score_tension],_sc_p.push(lp),_sc_h.push(lh),_sc_t.push(lt),e.dimensions.length>0&&angular.forEach(e.dimensions,function(dimname,dimkey){void 0==_sc_d[dimkey]&&(_sc_d[dimkey]=[]),_sc_d_bottom=top+$scope.o.clp_v+$scope.o.scr_v+(dimkey+1)*$scope.o.dim_v,_sc_d_height=$scope.o.dim_v-2*$scope.o.gut_rv,ld[dimkey]=[x,_sc_d_bottom-(e.thresholds[dimkey]>0?_sc_d_height/e.thresholds[dimkey]*e.tension_dimensions[dimkey]:0)],_sc_d[dimkey].push(ld[dimkey]),dimkey<e.dimensions.length-1&&lines_dotted.push(_sc_d_bottom),dimname==e.active_dimension&&PaperService.text(x+$scope.o.gut_h,top+$scope.o.clp_v+$scope.o.scr_v+dimkey*$scope.o.dim_v+$scope.o.fnt_s,e.keyword,$scope.o.fnt_s,$scope.o.col_s,"Helvetica",35)}),lines.push(_sc_d_bottom);var element_name=e.element_name.substring(0,30);element_name+=Array(31-element_name.length).join(" "),PaperService.text(x+$scope.o.gut_h,top+$scope.o.clp_v+$scope.o.scr_v+e.dimensions.length*$scope.o.dim_v+$scope.o.fnt_s,element_name,$scope.o.fnt_s,$scope.o.col_b,"Helvetica",35)}}),PaperService.text($scope.o.chn_l,top+$scope.o.clp_v/2+$scope.o.fnt_s/3,"Clips",$scope.o.fnt_s,$scope.o.col_b),PaperService.text($scope.o.chn_l,top+$scope.o.clp_v+$scope.o.scr_v/4+$scope.o.fnt_s/3,"Physics",$scope.o.fnt_s,$scope.o.col_p),PaperService.text($scope.o.chn_l,top+$scope.o.clp_v+$scope.o.scr_v/4*2+$scope.o.fnt_s/3,"History",$scope.o.fnt_s,$scope.o.col_h),PaperService.text($scope.o.chn_l,top+$scope.o.clp_v+$scope.o.scr_v/4*3+$scope.o.fnt_s/3,"Tension",$scope.o.fnt_s,$scope.o.col_t),$scope.e){var last_x=x+$scope.e.element_duration*$scope.o.fct_t;_sc_p.push([last_x,lp[1]]),_sc_h.push([last_x,lh[1]]),_sc_t.push([last_x,lt[1]]),PaperService.path(_sc_p,1,$scope.o.col_p),PaperService.path(_sc_h,1,$scope.o.col_h),PaperService.path(_sc_t,1,$scope.o.col_t),angular.forEach(_sc_d,function(points,dimkey){points.push([last_x,ld[dimkey][1]]),PaperService.path(points,1,$scope.o.col_t),PaperService.text($scope.o.chn_l,top+$scope.o.clp_v+$scope.o.scr_v+dimkey*$scope.o.dim_v+$scope.o.dim_v/2+$scope.o.fnt_s/3,$scope.e.dimensions[dimkey]+($scope.e.dimensions[dimkey]==$scope.e.master_dimension?"*":""),$scope.o.fnt_s,$scope.o.col_b)})}var bottom=20*Math.ceil(PaperService.getMax().y/20),live_x=$scope.o.chn_l+$scope.o.leg_w+live*$scope.o.fct_t;PaperService.path([[live_x,top],[live_x,top+$scope.o.clp_v]],2,$scope.o.col_t),angular.forEach(v_lines,function(line){PaperService.path([[line,top],[line,bottom]],1,$scope.o.col_b,[1,2])}),top=bottom}}),angular.forEach(lines,function(line){PaperService.path([[$scope.o.chn_l+$scope.o.leg_w,line],[PaperService.getMax().x,line]],1,$scope.o.col_b)}),angular.forEach(lines_dotted,function(line){PaperService.path([[$scope.o.chn_l+$scope.o.leg_w,line],[PaperService.getMax().x,line]],1,$scope.o.col_b,[1,2])}),PaperService.draw(),$ionicScrollDelegate.scrollBy(1e4,0,!0)},$scope.zoom=function(zoom_in){$scope.zoomfactor+=zoom_in?.1:$scope.zoomfactor>.2?-.1:0,console.log($scope.zoomfactor),$scope.draw()},$scope.trigger=function(){NetService.timeline($scope.auth_token,"trigger").then(function(){$scope.load()})},$scope.reset=function(){NetService.timeline($scope.auth_token,"reset").then(function(){$scope.load()})},$scope.load=function(){$scope.isLoading?console.log("already loading…"):($scope.isLoading=!0,NetService.timeline($scope.auth_token,"load").then(function(timeline){$scope.timeline=timeline,$scope.draw(),$scope.isLoading=!1}))},$scope.doLogin().then(function(state){state===!0&&(PaperService.init(document.getElementById("canvas")),NetService.loadchannels($scope.auth_token,!0).then(function(data){data.Error&&$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}),$scope.load(),$rootScope.interval=setInterval($scope.load,1e3)}))})}).controller("GraphCtrl",function($rootScope,$scope,$stateParams,$q,NetService,PaperService){$scope.o={},$scope.o.col_b=[1,1,1],$scope.o.col_g=[.5,.5,.5],$scope.o.col_c=[],$scope.o.col_c.push([0,1,0]),$scope.o.col_c.push([1,0,0]),$scope.o.col_c.push([.2,.4,1]),$scope.o.gut_h=2,$scope.o.chn_l=0,$scope.o.chn_t=10,$scope.o.fnt_s=9,$scope.draw=function(){PaperService.clear(),$scope.o.max_width=window.getSize().x,$scope.o.max_height=window.getSize().y-90,angular.forEach($scope.keywords,function(data){null!=data.Keywords&&Object.keys(data.Keywords).length>0&&1==data.Target[2]&&angular.forEach(data.Keywords,function(coord,name){var x=$scope.o.chn_l+($scope.o.max_width-2*$scope.o.chn_l)/100*coord[0],y=$scope.o.chn_t+($scope.o.max_height-2*$scope.o.chn_t)/100*coord[1];PaperService.circle(x,y,2,$scope.o.col_b,$scope.o.col_b),PaperService.text(x+2*$scope.o.gut_h,y+$scope.o.fnt_s-$scope.o.fnt_s/4+$scope.o.gut_h,name,$scope.o.fnt_s,$scope.o.col_b)})});var channel_count=0,last_pos=[];angular.forEach($scope.timeline,function(_data){{var data=_data.data;_data.live||0}null!=data&&data.length>0&&(angular.forEach(data,function(e,nr){if(e.element_id){var elm_pos=[];elm_pos[0]=$scope.o.chn_l+($scope.o.max_width-2*$scope.o.chn_l)/100*e.current_position[0],elm_pos[1]=$scope.o.chn_t+($scope.o.max_height-2*$scope.o.chn_t)/100*e.current_position[1];var cur_pos=[(void 0!=e.cursor.Position?e.cursor.Position:e.cursor)[0],(void 0!=e.cursor.Position?e.cursor.Position:e.cursor)[1]],key_pos=[$scope.keywords[e.active_dimension].Keywords[e.keyword][0],$scope.keywords[e.active_dimension].Keywords[e.keyword][1]],to_pos=[$scope.keywords[e.active_dimension].Keywords[e.tokeyword][0],$scope.keywords[e.active_dimension].Keywords[e.tokeyword][1]];
if(console.log("Cursor: "+cur_pos),console.log("Key "+e.keyword+" in "+e.active_dimension+": "+key_pos),cur_pos[0]=$scope.o.chn_l+($scope.o.max_width-2*$scope.o.chn_l)/100*cur_pos[0],cur_pos[1]=$scope.o.chn_t+($scope.o.max_height-2*$scope.o.chn_t)/100*cur_pos[1],key_pos[0]=$scope.o.chn_l+($scope.o.max_width-2*$scope.o.chn_l)/100*key_pos[0],key_pos[1]=$scope.o.chn_t+($scope.o.max_height-2*$scope.o.chn_t)/100*key_pos[1],to_pos[0]=$scope.o.chn_l+($scope.o.max_width-2*$scope.o.chn_l)/100*to_pos[0],to_pos[1]=$scope.o.chn_t+($scope.o.max_height-2*$scope.o.chn_t)/100*to_pos[1],PaperService.circle(elm_pos[0],elm_pos[1],2,$scope.o.col_c[channel_count],$scope.o.col_c[channel_count]),last_pos&&PaperService.path([elm_pos,last_pos],1,$scope.o.col_c[channel_count]),nr==data.length-1){PaperService.path([elm_pos,key_pos],1,$scope.o.col_g,[4,2]),PaperService.path([elm_pos,to_pos],1,$scope.o.col_b,[4,2]);var element_name=e.element_name.substring(0,30);PaperService.text(elm_pos[0]+2*$scope.o.gut_h,elm_pos[1]+$scope.o.fnt_s-$scope.o.fnt_s/4+$scope.o.gut_h,element_name,$scope.o.fnt_s,$scope.o.col_c[channel_count])}last_pos=elm_pos.clone()}}),channel_count++)}),PaperService.draw()},$scope.trigger=function(){NetService.timeline($scope.auth_token,"trigger").then(function(){$scope.load()})},$scope.reset=function(){NetService.timeline($scope.auth_token,"reset").then(function(){$scope.load()})},$scope.load=function(){$scope.isLoading?console.log("already loading…"):($scope.isLoading=!0,NetService.load("target",$scope.auth_token).then(function(data){$scope.keywords=data,NetService.timeline($scope.auth_token,"load").then(function(timeline){$scope.timeline=timeline,$scope.draw(),$scope.isLoading=!1})}))},$scope.doLogin().then(function(state){state===!0&&(PaperService.init(document.getElementById("canvas")),NetService.loadchannels($scope.auth_token,!0).then(function(data){data.Error&&$ionicPopup.alert({title:"Error "+data.Error.Code,template:data.Error.Message}),$scope.load(),$rootScope.interval=setInterval($scope.load,1e3)}))})});